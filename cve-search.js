document.addEventListener('DOMContentLoaded', () => {
    const input = document.getElementById('searchInput');
    const results = document.getElementById('results');
    let debounceTimeout = null;

    const formatDate = (dateStr) => {
        if(!dateStr) return 'N/A';
        const d = new Date(dateStr);
        return d.toLocaleDateString();
    }

    async function fetchCveData(keyword) {
        if(!keyword.trim()) {
            results.innerHTML = '<p class="info-text">Start typing to search CVEs...</p>';
            return;
        }
        results.innerHTML = '<p><i class="fas fa-spinner fa-spin"></i> Fetching data...</p>';
        try {
            const url = new URL('https://services.nvd.nist.gov/rest/json/cves/2.0');
            url.searchParams.append('keywordSearch', keyword);
            url.searchParams.append('resultsPerPage', '25');
            const res = await fetch(url);
            if(!res.ok) throw new Error(`Network error (${res.status})`);
            const data = await res.json();
            if(!data.vulnerabilities || data.vulnerabilities.length === 0){
                results.innerHTML = '<p class="no-results">No CVEs found.</p>';
                return;
            }
            results.innerHTML = '';
            data.vulnerabilities.forEach(vuln => {
                const cve = vuln.cve;
                const id = cve.id;
                const title = cve.descriptions[0]?.value || 'No description available';
                const published = formatDate(cve.published);
                const cvssV3 = cve.metrics?.cvssMetricV31?.[0];
                const severity = cvssV3?.cvssData?.baseSeverity || 'Unknown';
                const score = cvssV3?.cvssData?.baseScore ?? 'N/A';
                const item = document.createElement('div');
                item.className = 'result-item';
                item.tabIndex = 0;
                item.innerHTML = `
                    <div class="res-title">${id} <span style="font-weight:400; font-size:0.85rem; color:#888;">[${severity} | ${score}]</span></div>
                    <div class="res-description">${title}</div>
                    <div class="res-meta">
                        <span>Published: ${published}</span>
                        <a href="https://nvd.nist.gov/vuln/detail/${id}" target="_blank" rel="noopener noreferrer" tabindex="-1">Details <i class="fas fa-external-link-alt" style="font-size:0.8rem;"></i></a>
                    </div>`;
                results.appendChild(item);
            });
        } catch(e){
            results.innerHTML = `<p class="no-results">Error fetching CVE data: ${e.message}</p>`;
        }
    }

    input.addEventListener('input', () => {
        clearTimeout(debounceTimeout);
        debounceTimeout = setTimeout(() => fetchCveData(input.value.trim()), 600);
    });
});
